'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Router = Router;

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _ciAdapter = require('ci-adapter');

var _util = require('util');

var _uuid = require('uuid-1345');

var _uuid2 = _interopRequireDefault(_uuid);

var _build = require('./build');

var _build2 = _interopRequireDefault(_build);

var _builder = require('./builder');

var _builder2 = _interopRequireDefault(_builder);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function urlResolver(req) {
  var base = 0;
  return function (object) {
    if (object instanceof _build2.default) {} else if (object instanceof _builder2.default) {}
  };
}

function Router(adapter, options) {
  var router = _express2.default.Router();

  var adapter = adapter;

  router.get('/', function (req, res, next) {
    builds(adapter).then(function (builds) {
      return {
        builds: builds.map(function (build) {
          return build.id;
        }),
        latest: builds[0]
      };
    });
  });

  router.get('/builders', function (req, res, next) {
    builders(adapter).then(send(res), error(res));
  });

  router.get('/builds', function (req, res, next) {
    builds(adapter).then(send(res), error(res));
  });

  router.get('/latest', function (req, res, next) {
    builds(adapter).then(function (builds) {
      return builds[0];
    }).then(send(res), error(res));
  });

  return router;
}

function send(res) {
  return function (data) {
    return res.send(data);
  };
}

function error(res) {
  return function (err) {
    return res.status(500).send(err);
  };
}

function uuid(url) {
  return new Promise(function (resolve, reject) {
    _uuid2.default.v5({
      namespace: _uuid2.default.namespace.url,
      name: url
    }, function (err, uuid) {
      if (err) return reject(err);
      resolve(uuid);
    });
  });
}

function pmap(promise, callback) {
  return promise.then(function (list) {
    return Promise.all(list.map(callback));
  });
}

function pfmap(promise, callback) {
  return pmap(promise, callback).then(function (lists) {
    var _ref;

    return (_ref = []).concat.apply(_ref, _toConsumableArray(lists));
  });
}

function builders(adapter) {
  return pmap(adapter.getBuilders(), function (builder) {
    return pmap(adapter.getBuilds(builder), function (build) {
      return uuid(build.url);
    }).then(function (builds) {
      return uuid(builder.url).then(function (uuid) {
        return {
          id: uuid,
          name: builder.name,
          builds: builds
        };
      });
    });
  });
}

function builds(adapter) {
  return pfmap(adapter.getBuilders(), adapter.getBuilds).then(function (builds) {
    var sorted = builds.sort(function (a, b) {
      return b.end.getTime() - a.end.getTime();
    });

    return Promise.all(sorted.map(function (build) {
      return uuid(build.url).then(function (uuid) {
        return {
          id: uuid,
          name: build.name,
          number: build.number,
          state: build.state,
          start: build.start,
          end: build.end
        };
      });
    }));
  });
}
//# sourceMappingURL=data:application/json;base64,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QUFTLE1BQU0sQ0FBQyxPQUFPLEVBQUU7QUFDdkIsU0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxNQUFNLEVBQUU7QUFDNUUsUUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBRSxVQUFDLENBQUMsRUFBRSxDQUFDO2FBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRTtLQUFBLENBQUUsQ0FBQzs7QUFFMUUsV0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxLQUFLLEVBQUU7QUFDN0MsYUFBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRTtBQUMxQyxlQUFPO0FBQ0wsWUFBRSxFQUFFLElBQUk7QUFDUixjQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7QUFDaEIsZ0JBQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtBQUNwQixlQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7QUFDbEIsZUFBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2xCLGFBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztTQUNmLENBQUM7T0FDSCxDQUFDLENBQUM7S0FDSixDQUFDLENBQUMsQ0FBQztHQUNMLENBQUMsQ0FBQztDQUNKIiwiZmlsZSI6InJvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgc3RhdGUgfSBmcm9tICdjaS1hZGFwdGVyJztcbmltcG9ydCB7IGluaGVyaXRzIH0gZnJvbSAndXRpbCc7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLTEzNDUnO1xuaW1wb3J0IEJ1aWxkIGZyb20gJy4vYnVpbGQnO1xuaW1wb3J0IEJ1aWxkZXIgZnJvbSAnLi9idWlsZGVyJztcblxuZnVuY3Rpb24gdXJsUmVzb2x2ZXIocmVxKSB7XG4gIHZhciBiYXNlID0gMDtcbiAgcmV0dXJuIGZ1bmN0aW9uIChvYmplY3QpIHtcbiAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgQnVpbGQpIHtcbiAgICB9IGVsc2UgaWYgKG9iamVjdCBpbnN0YW5jZW9mIEJ1aWxkZXIpIHtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBSb3V0ZXIoYWRhcHRlciwgb3B0aW9ucykge1xuICB2YXIgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcblxuICB2YXIgYWRhcHRlciA9IGFkYXB0ZXI7XG5cbiAgcm91dGVyLmdldCgnLycsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIGJ1aWxkcyhhZGFwdGVyKS50aGVuKGZ1bmN0aW9uIChidWlsZHMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGJ1aWxkczogYnVpbGRzLm1hcChidWlsZCA9PiBidWlsZC5pZCksXG4gICAgICAgIGxhdGVzdDogYnVpbGRzWzBdXG4gICAgICB9O1xuICAgIH0pO1xuICB9KTtcblxuICByb3V0ZXIuZ2V0KCcvYnVpbGRlcnMnLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICBidWlsZGVycyhhZGFwdGVyKS50aGVuKHNlbmQocmVzKSwgZXJyb3IocmVzKSk7XG4gIH0pO1xuXG4gIHJvdXRlci5nZXQoJy9idWlsZHMnLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICBidWlsZHMoYWRhcHRlcikudGhlbihzZW5kKHJlcyksIGVycm9yKHJlcykpO1xuICB9KTtcblxuICByb3V0ZXIuZ2V0KCcvbGF0ZXN0JywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgYnVpbGRzKGFkYXB0ZXIpLnRoZW4oZnVuY3Rpb24gKGJ1aWxkcykge1xuICAgICAgcmV0dXJuIGJ1aWxkc1swXTtcbiAgICB9KS50aGVuKHNlbmQocmVzKSwgZXJyb3IocmVzKSk7XG4gIH0pO1xuXG4gIHJldHVybiByb3V0ZXI7XG59XG5cbmZ1bmN0aW9uIHNlbmQocmVzKSB7XG4gIHJldHVybiBkYXRhID0+IHJlcy5zZW5kKGRhdGEpO1xufVxuXG5mdW5jdGlvbiBlcnJvcihyZXMpIHtcbiAgcmV0dXJuIGVyciA9PiByZXMuc3RhdHVzKDUwMCkuc2VuZChlcnIpO1xufVxuXG5mdW5jdGlvbiB1dWlkKHVybCkge1xuICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgIFVVSUQudjUoe1xuICAgICAgbmFtZXNwYWNlOiBVVUlELm5hbWVzcGFjZS51cmwsXG4gICAgICBuYW1lOiB1cmxcbiAgICB9LCBmdW5jdGlvbiAoZXJyLCB1dWlkKSB7XG4gICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICByZXNvbHZlKHV1aWQpO1xuICAgIH0pO1xuICB9KTtcbn1cblxuXG5mdW5jdGlvbiBwbWFwKHByb21pc2UsIGNhbGxiYWNrKSB7XG4gIHJldHVybiBwcm9taXNlLnRoZW4obGlzdCA9PiBQcm9taXNlLmFsbChsaXN0Lm1hcChjYWxsYmFjaykpKTtcbn1cblxuZnVuY3Rpb24gcGZtYXAocHJvbWlzZSwgY2FsbGJhY2spIHtcbiAgcmV0dXJuIHBtYXAocHJvbWlzZSwgY2FsbGJhY2spLnRoZW4obGlzdHMgPT4gW10uY29uY2F0KCAuLi5saXN0cyApKTtcbn1cblxuZnVuY3Rpb24gYnVpbGRlcnMoYWRhcHRlcikge1xuICByZXR1cm4gcG1hcChhZGFwdGVyLmdldEJ1aWxkZXJzKCksIGZ1bmN0aW9uIChidWlsZGVyKSB7XG4gICAgcmV0dXJuIHBtYXAoYWRhcHRlci5nZXRCdWlsZHMoYnVpbGRlciksIGZ1bmN0aW9uIChidWlsZCkge1xuICAgICAgcmV0dXJuIHV1aWQoYnVpbGQudXJsKTtcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChidWlsZHMpIHtcbiAgICAgIHJldHVybiB1dWlkKGJ1aWxkZXIudXJsKS50aGVuKGZ1bmN0aW9uICh1dWlkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaWQ6IHV1aWQsXG4gICAgICAgICAgbmFtZTogYnVpbGRlci5uYW1lLFxuICAgICAgICAgIGJ1aWxkczogYnVpbGRzXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkcyhhZGFwdGVyKSB7XG4gIHJldHVybiBwZm1hcChhZGFwdGVyLmdldEJ1aWxkZXJzKCksIGFkYXB0ZXIuZ2V0QnVpbGRzKS50aGVuKGZ1bmN0aW9uIChidWlsZHMpIHtcbiAgICBjb25zdCBzb3J0ZWQgPSBidWlsZHMuc29ydCggKGEsIGIpID0+IGIuZW5kLmdldFRpbWUoKSAtIGEuZW5kLmdldFRpbWUoKSApO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHNvcnRlZC5tYXAoZnVuY3Rpb24gKGJ1aWxkKSB7XG4gICAgICByZXR1cm4gdXVpZChidWlsZC51cmwpLnRoZW4oZnVuY3Rpb24gKHV1aWQpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpZDogdXVpZCxcbiAgICAgICAgICBuYW1lOiBidWlsZC5uYW1lLFxuICAgICAgICAgIG51bWJlcjogYnVpbGQubnVtYmVyLFxuICAgICAgICAgIHN0YXRlOiBidWlsZC5zdGF0ZSxcbiAgICAgICAgICBzdGFydDogYnVpbGQuc3RhcnQsXG4gICAgICAgICAgZW5kOiBidWlsZC5lbmRcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0pKTtcbiAgfSk7XG59XG4iXX0=