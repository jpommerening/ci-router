'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Router = Router;

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _ciAdapter = require('ci-adapter');

var _util = require('util');

var _id = require('./id');

var _model = require('./model');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function Router(adapter, options) {
  var router = _express2.default.Router();
  var model = (0, _model.Model)(adapter, {
    id: {
      get: function get() {
        return this.data.then(_id.id);
      }
    },
    url: {
      get: function get() {
        if (this instanceof _model.Build) {
          return this.id.then(function (id) {
            return '/builds/' + id;
          });
        }
        if (this instanceof _model.Builder) {
          return this.id.then(function (id) {
            return '/builders/' + id;
          });
        }
      }
    }
  });

  router.get('/', function (req, res, next) {
    builds(adapter).then(function (builds) {
      return {
        builds: builds.map(function (build) {
          return build.id;
        }),
        latest: builds[0]
      };
    });
  });

  router.get('/builders', function (req, res, next) {
    model.builders().then(send(res), error(res));
  });

  router.get('/builds', function (req, res, next) {
    model.builds().then(send(res), error(res));
  });

  router.get('/latest', function (req, res, next) {
    builds(adapter).then(function (builds) {
      return builds[0];
    }).then(send(res), error(res));
  });

  return router;
}

function send(res) {
  return function (data) {
    return res.send(data);
  };
}

function error(res) {
  return function (err) {
    res.status(500);
    res.send({
      message: err.toString()
    });
    console.log(err);
  };
}

function pmap(promise, callback) {
  return promise.then(function (list) {
    return Promise.all(list.map(callback));
  });
}

function pfmap(promise, callback) {
  return pmap(promise, callback).then(function (lists) {
    var _ref;

    return (_ref = []).concat.apply(_ref, _toConsumableArray(lists));
  });
}

function builders(adapter) {
  return pmap(adapter.getBuilders(), function (builder) {
    return pmap(adapter.getBuilds(builder), function (build) {
      return (0, _id.id)(build);
    }).then(function (builds) {
      return (0, _id.id)(builder).then(function (id) {
        return {
          id: id,
          html_url: builder.html_url,
          name: builder.name,
          builds: builds
        };
      });
    });
  });
}

function builds(adapter) {
  return pfmap(adapter.getBuilders(), adapter.getBuilds).then(function (builds) {
    var now = new Date();
    var sorted = builds.sort(function (a, b) {
      return (b.end || now).getTime() - (a.end || now).getTime();
    });

    return Promise.all(sorted.map(function (build) {
      return (0, _id.id)(build).then(function (id) {
        return {
          id: id,
          html_url: build.html_url,
          name: build.name,
          number: build.number,
          state: build.state,
          start: build.start,
          end: build.end
        };
      });
    }));
  });
}
//# sourceMappingURL=data:application/json;base64,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QUNILENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztDQUNKOztBQUVELFNBQVMsTUFBTSxDQUFDLE9BQU8sRUFBRTtBQUN2QixTQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLE1BQU0sRUFBRTtBQUM1RSxRQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0FBQ3ZCLFFBQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUUsVUFBQyxDQUFDLEVBQUUsQ0FBQzthQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUEsQ0FBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFBLENBQUUsT0FBTyxFQUFFO0tBQUEsQ0FBRSxDQUFDOztBQUU1RixXQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEtBQUssRUFBRTtBQUM3QyxhQUFPLFFBOUZKLEVBQUUsRUE4RkssS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFO0FBQ2xDLGVBQU87QUFDTCxZQUFFLEVBQUUsRUFBRTtBQUNOLGtCQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVE7QUFDeEIsY0FBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO0FBQ2hCLGdCQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07QUFDcEIsZUFBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2xCLGVBQUssRUFBRSxLQUFLLENBQUMsS0FBSztBQUNsQixhQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7U0FDZixDQUFDO09BQ0gsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDLENBQUM7R0FDTCxDQUFDLENBQUM7Q0FDSiIsImZpbGUiOiJyb3V0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHN0YXRlIH0gZnJvbSAnY2ktYWRhcHRlcic7XG5pbXBvcnQgeyBpbmhlcml0cyB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IHsgaWQgfSBmcm9tICcuL2lkJztcbmltcG9ydCB7IE1vZGVsLCBCdWlsZCwgQnVpbGRlciB9IGZyb20gJy4vbW9kZWwnO1xuXG5leHBvcnQgZnVuY3Rpb24gUm91dGVyKGFkYXB0ZXIsIG9wdGlvbnMpIHtcbiAgY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbiAgY29uc3QgbW9kZWwgPSBNb2RlbChhZGFwdGVyLCB7XG4gICAgaWQ6IHtcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLnRoZW4oaWQpO1xuICAgICAgfVxuICAgIH0sXG4gICAgdXJsOiB7XG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBCdWlsZCkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmlkLnRoZW4oaWQgPT4gYC9idWlsZHMvJHtpZH1gKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIEJ1aWxkZXIpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5pZC50aGVuKGlkID0+IGAvYnVpbGRlcnMvJHtpZH1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgcm91dGVyLmdldCgnLycsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIGJ1aWxkcyhhZGFwdGVyKS50aGVuKGZ1bmN0aW9uIChidWlsZHMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGJ1aWxkczogYnVpbGRzLm1hcChidWlsZCA9PiBidWlsZC5pZCksXG4gICAgICAgIGxhdGVzdDogYnVpbGRzWzBdXG4gICAgICB9O1xuICAgIH0pO1xuICB9KTtcblxuICByb3V0ZXIuZ2V0KCcvYnVpbGRlcnMnLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICBtb2RlbC5idWlsZGVycygpLnRoZW4oc2VuZChyZXMpLCBlcnJvcihyZXMpKTtcbiAgfSk7XG5cbiAgcm91dGVyLmdldCgnL2J1aWxkcycsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIG1vZGVsLmJ1aWxkcygpLnRoZW4oc2VuZChyZXMpLCBlcnJvcihyZXMpKTtcbiAgfSk7XG5cbiAgcm91dGVyLmdldCgnL2xhdGVzdCcsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIGJ1aWxkcyhhZGFwdGVyKS50aGVuKGZ1bmN0aW9uIChidWlsZHMpIHtcbiAgICAgIHJldHVybiBidWlsZHNbMF07XG4gICAgfSkudGhlbihzZW5kKHJlcyksIGVycm9yKHJlcykpO1xuICB9KTtcblxuICByZXR1cm4gcm91dGVyO1xufVxuXG5mdW5jdGlvbiBzZW5kKHJlcykge1xuICByZXR1cm4gZGF0YSA9PiByZXMuc2VuZChkYXRhKTtcbn1cblxuZnVuY3Rpb24gZXJyb3IocmVzKSB7XG4gIHJldHVybiBmdW5jdGlvbiAoZXJyKSB7XG4gICAgcmVzLnN0YXR1cyg1MDApO1xuICAgIHJlcy5zZW5kKHtcbiAgICAgIG1lc3NhZ2U6IGVyci50b1N0cmluZygpXG4gICAgfSk7XG4gICAgY29uc29sZS5sb2coZXJyKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gcG1hcChwcm9taXNlLCBjYWxsYmFjaykge1xuICByZXR1cm4gcHJvbWlzZS50aGVuKGxpc3QgPT4gUHJvbWlzZS5hbGwobGlzdC5tYXAoY2FsbGJhY2spKSk7XG59XG5cbmZ1bmN0aW9uIHBmbWFwKHByb21pc2UsIGNhbGxiYWNrKSB7XG4gIHJldHVybiBwbWFwKHByb21pc2UsIGNhbGxiYWNrKS50aGVuKGxpc3RzID0+IFtdLmNvbmNhdCggLi4ubGlzdHMgKSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkZXJzKGFkYXB0ZXIpIHtcbiAgcmV0dXJuIHBtYXAoYWRhcHRlci5nZXRCdWlsZGVycygpLCBmdW5jdGlvbiAoYnVpbGRlcikge1xuICAgIHJldHVybiBwbWFwKGFkYXB0ZXIuZ2V0QnVpbGRzKGJ1aWxkZXIpLCBmdW5jdGlvbiAoYnVpbGQpIHtcbiAgICAgIHJldHVybiBpZChidWlsZCk7XG4gICAgfSkudGhlbihmdW5jdGlvbiAoYnVpbGRzKSB7XG4gICAgICByZXR1cm4gaWQoYnVpbGRlcikudGhlbihmdW5jdGlvbiAoaWQpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpZDogaWQsXG4gICAgICAgICAgaHRtbF91cmw6IGJ1aWxkZXIuaHRtbF91cmwsXG4gICAgICAgICAgbmFtZTogYnVpbGRlci5uYW1lLFxuICAgICAgICAgIGJ1aWxkczogYnVpbGRzXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkcyhhZGFwdGVyKSB7XG4gIHJldHVybiBwZm1hcChhZGFwdGVyLmdldEJ1aWxkZXJzKCksIGFkYXB0ZXIuZ2V0QnVpbGRzKS50aGVuKGZ1bmN0aW9uIChidWlsZHMpIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHNvcnRlZCA9IGJ1aWxkcy5zb3J0KCAoYSwgYikgPT4gKGIuZW5kIHx8IG5vdykuZ2V0VGltZSgpIC0gKGEuZW5kIHx8IG5vdykuZ2V0VGltZSgpICk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoc29ydGVkLm1hcChmdW5jdGlvbiAoYnVpbGQpIHtcbiAgICAgIHJldHVybiBpZChidWlsZCkudGhlbihmdW5jdGlvbiAoaWQpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpZDogaWQsXG4gICAgICAgICAgaHRtbF91cmw6IGJ1aWxkLmh0bWxfdXJsLFxuICAgICAgICAgIG5hbWU6IGJ1aWxkLm5hbWUsXG4gICAgICAgICAgbnVtYmVyOiBidWlsZC5udW1iZXIsXG4gICAgICAgICAgc3RhdGU6IGJ1aWxkLnN0YXRlLFxuICAgICAgICAgIHN0YXJ0OiBidWlsZC5zdGFydCxcbiAgICAgICAgICBlbmQ6IGJ1aWxkLmVuZFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSkpO1xuICB9KTtcbn1cbiJdfQ==