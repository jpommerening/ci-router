'use strict';

var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; })();

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Router = Router;

var _ciAdapter = require('ci-adapter');

var _util = require('util');

var _url = require('url');

var _id = require('./id');

var _model = require('./model');

function Router(adapter, options) {
  var model = (0, _model.Model)(adapter, {
    id: {
      get: function get() {
        return (0, _id.id)(this.data);
      }
    }
  });
  var handlers = {
    '/': function _(req, res, next) {
      var builders = model.builders();
      var builds = model.builds();

      Promise.all([builders.then(function (builders) {
        return Promise.all(builders.map(function (builder) {
          return builder.id;
        }));
      }), builds.then(function (builds) {
        return Promise.all(builds.map(function (build) {
          return build.id;
        }));
      }), builds.then(function (builds) {
        return builds.filter(function (build) {
          return build.state === _ciAdapter.state.PENDING;
        });
      })]).then(function (_ref) {
        var _ref2 = _slicedToArray(_ref, 3);

        var builders = _ref2[0];
        var builds = _ref2[1];
        var pending = _ref2[2];
        return { builders: builders, builds: builds, pending: pending };
      }).then(send(req, res), error(res));
    },
    '/builders': function builders(req, res, next) {
      model.builders().then(function (builders) {
        return Promise.all(builders.map(builderData(req)));
      }).then(send(req, res), error(res));
    },
    '/builds': function builds(req, res, next) {
      model.builds().then(function (builds) {
        return Promise.all(builds.map(buildData(req)));
      }).then(send(req, res), error(res));
    },
    '/latest': function latest(req, res, next) {
      model.builds().then(function (builds) {
        return buildData(req)(builds[0]);
      }).then(send(req, res), error(res));
    }
  };

  return function (req, res, next) {
    if (req.method === 'GET' && req.url in handlers) {
      return handlers[req.url](req, res, next);
    } else {
      return next();
    }
  };
}

function getBaseUrl(req) {
  function first(string) {
    return string && string.split(/\s*,\s*/)[0];
  }

  var proto = first(req.headers['x-forwarded-proto']) || (req.socket.encrypted ? 'https' : 'http');
  var host = first(req.headers['x-forwarded-host']) || req.headers.host;
  var base = req.baseUrl || '';
  return proto + '://' + host + base;
}

function builderData(req) {
  var endpoint = getBaseUrl(req);
  return function (builder) {
    return builder.id.then(function (id) {
      var url = endpoint + '/builder/' + id;
      var urls = [builder.data.url].concat(builder.data.data.urls || []);
      var data = Object.assign({}, builder.data, { url: url, data: { urls: urls } });
      return data;
    });
  };
}

function buildData(req) {
  var endpoint = getBaseUrl(req);
  return function (build) {
    return build.id.then(function (id) {
      var url = endpoint + '/builder/' + id;
      var urls = [build.data.url].concat(build.data.data.urls || []);
      var data = Object.assign({}, build.data, { url: url, data: { urls: urls } });
      return data;
    });
  };
}

function send(req, res) {
  var url = req.parsedUrl || (0, _url.parse)(req.url, true);
  var pretty = !!url.query.pretty;
  return function (data) {
    res.setHeader('Content-Type', 'application/json');
    res.write(JSON.stringify(data, null, pretty && 2));
    res.end();
  };
  return function (data) {
    return res.json(data);
  };
}

function error(res) {
  return function (err) {
    res.statusCode = 500;
    res.setHeader('Content-Type', 'application/json');
    res.write(JSON.stringify({ message: err.toString() }));
    res.end();
  };
}
//# sourceMappingURL=data:application/json;base64,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Q0FBQztDQUNIIiwiZmlsZSI6InJvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHN0YXRlIH0gZnJvbSAnY2ktYWRhcHRlcic7XG5pbXBvcnQgeyBpbmhlcml0cyB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IHsgcGFyc2UgYXMgcGFyc2VVcmwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgaWQgfSBmcm9tICcuL2lkJztcbmltcG9ydCB7IE1vZGVsLCBCdWlsZCwgQnVpbGRlciB9IGZyb20gJy4vbW9kZWwnO1xuXG5leHBvcnQgZnVuY3Rpb24gUm91dGVyKGFkYXB0ZXIsIG9wdGlvbnMpIHtcbiAgY29uc3QgbW9kZWwgPSBNb2RlbChhZGFwdGVyLCB7XG4gICAgaWQ6IHtcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gaWQodGhpcy5kYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICBjb25zdCBoYW5kbGVycyA9IHtcbiAgICAnLyc6IGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgICAgY29uc3QgYnVpbGRlcnMgPSBtb2RlbC5idWlsZGVycygpO1xuICAgICAgY29uc3QgYnVpbGRzID0gbW9kZWwuYnVpbGRzKCk7XG5cbiAgICAgIFByb21pc2UuYWxsKFtcbiAgICAgICAgYnVpbGRlcnMudGhlbihidWlsZGVycyA9PiBQcm9taXNlLmFsbChidWlsZGVycy5tYXAoYnVpbGRlciA9PiBidWlsZGVyLmlkKSkpLFxuICAgICAgICBidWlsZHMudGhlbihidWlsZHMgPT4gUHJvbWlzZS5hbGwoYnVpbGRzLm1hcChidWlsZCA9PiBidWlsZC5pZCkpKSxcbiAgICAgICAgYnVpbGRzLnRoZW4oYnVpbGRzID0+IGJ1aWxkcy5maWx0ZXIoYnVpbGQgPT4gYnVpbGQuc3RhdGUgPT09IHN0YXRlLlBFTkRJTkcpKVxuICAgICAgXSkudGhlbigoWyBidWlsZGVycywgYnVpbGRzLCBwZW5kaW5nIF0pID0+ICh7IGJ1aWxkZXJzLCBidWlsZHMsIHBlbmRpbmcgfSkpLnRoZW4oc2VuZChyZXEsIHJlcyksIGVycm9yKHJlcykpO1xuICAgIH0sXG4gICAgJy9idWlsZGVycyc6IGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgICAgbW9kZWwuYnVpbGRlcnMoKVxuICAgICAgICAudGhlbihidWlsZGVycyA9PiBQcm9taXNlLmFsbChidWlsZGVycy5tYXAoYnVpbGRlckRhdGEocmVxKSkpKVxuICAgICAgICAudGhlbihzZW5kKHJlcSwgcmVzKSwgZXJyb3IocmVzKSk7XG4gICAgfSxcbiAgICAnL2J1aWxkcyc6IGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgICAgbW9kZWwuYnVpbGRzKClcbiAgICAgICAgLnRoZW4oYnVpbGRzID0+IFByb21pc2UuYWxsKGJ1aWxkcy5tYXAoYnVpbGREYXRhKHJlcSkpKSlcbiAgICAgICAgLnRoZW4oc2VuZChyZXEsIHJlcyksIGVycm9yKHJlcykpO1xuICAgIH0sXG4gICAgJy9sYXRlc3QnOiBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICAgIG1vZGVsLmJ1aWxkcygpXG4gICAgICAgIC50aGVuKGJ1aWxkcyA9PiBidWlsZERhdGEocmVxKShidWlsZHNbIDAgXSkpXG4gICAgICAgIC50aGVuKHNlbmQocmVxLCByZXMpLCBlcnJvcihyZXMpKTtcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIGlmIChyZXEubWV0aG9kID09PSAnR0VUJyAmJiByZXEudXJsIGluIGhhbmRsZXJzKSB7XG4gICAgICByZXR1cm4gaGFuZGxlcnNbcmVxLnVybF0ocmVxLCByZXMsIG5leHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH1cbiAgfTtcbn1cblxuXG5mdW5jdGlvbiBnZXRCYXNlVXJsKHJlcSkge1xuICBmdW5jdGlvbiBmaXJzdChzdHJpbmcpIHtcbiAgICByZXR1cm4gc3RyaW5nICYmIHN0cmluZy5zcGxpdCgvXFxzKixcXHMqLylbMF07XG4gIH1cblxuICBjb25zdCBwcm90byA9IGZpcnN0KHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1wcm90byddKSB8fCAoIHJlcS5zb2NrZXQuZW5jcnlwdGVkID8gJ2h0dHBzJyA6ICdodHRwJyApO1xuICBjb25zdCBob3N0ID0gZmlyc3QocmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWhvc3QnXSkgfHwgcmVxLmhlYWRlcnMuaG9zdDtcbiAgY29uc3QgYmFzZSA9IHJlcS5iYXNlVXJsIHx8ICcnO1xuICByZXR1cm4gYCR7cHJvdG99Oi8vJHtob3N0fSR7YmFzZX1gXG59XG5cbmZ1bmN0aW9uIGJ1aWxkZXJEYXRhKHJlcSkge1xuICBjb25zdCBlbmRwb2ludCA9IGdldEJhc2VVcmwocmVxKTtcbiAgcmV0dXJuIGZ1bmN0aW9uIChidWlsZGVyKSB7XG4gICAgcmV0dXJuIGJ1aWxkZXIuaWQudGhlbihmdW5jdGlvbiAoaWQpIHtcbiAgICAgIGNvbnN0IHVybCA9IGAke2VuZHBvaW50fS9idWlsZGVyLyR7aWR9YDtcbiAgICAgIGNvbnN0IHVybHMgPSBbIGJ1aWxkZXIuZGF0YS51cmwgXS5jb25jYXQoYnVpbGRlci5kYXRhLmRhdGEudXJscyB8fCBbXSk7XG4gICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgYnVpbGRlci5kYXRhLCB7IHVybCwgZGF0YTogeyB1cmxzIH19KTtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0pO1xuICB9O1xufVxuXG5mdW5jdGlvbiBidWlsZERhdGEocmVxKSB7XG4gIGNvbnN0IGVuZHBvaW50ID0gZ2V0QmFzZVVybChyZXEpO1xuICByZXR1cm4gZnVuY3Rpb24gKGJ1aWxkKSB7XG4gICAgcmV0dXJuIGJ1aWxkLmlkLnRoZW4oZnVuY3Rpb24gKGlkKSB7XG4gICAgICBjb25zdCB1cmwgPSBgJHtlbmRwb2ludH0vYnVpbGRlci8ke2lkfWA7XG4gICAgICBjb25zdCB1cmxzID0gWyBidWlsZC5kYXRhLnVybCBdLmNvbmNhdChidWlsZC5kYXRhLmRhdGEudXJscyB8fCBbXSk7XG4gICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgYnVpbGQuZGF0YSwgeyB1cmwsIGRhdGE6IHsgdXJscyB9fSk7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9KTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gc2VuZChyZXEsIHJlcykge1xuICBjb25zdCB1cmwgPSByZXEucGFyc2VkVXJsIHx8IHBhcnNlVXJsKHJlcS51cmwsIHRydWUpO1xuICBjb25zdCBwcmV0dHkgPSAhISh1cmwucXVlcnkucHJldHR5KTtcbiAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICByZXMud3JpdGUoSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgcHJldHR5ICYmIDIpKTtcbiAgICByZXMuZW5kKCk7XG4gIH1cbiAgcmV0dXJuIGRhdGEgPT4gcmVzLmpzb24oZGF0YSk7XG59XG5cbmZ1bmN0aW9uIGVycm9yKHJlcykge1xuICByZXR1cm4gZnVuY3Rpb24gKGVycikge1xuICAgIHJlcy5zdGF0dXNDb2RlID0gNTAwO1xuICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgcmVzLndyaXRlKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogZXJyLnRvU3RyaW5nKCkgfSkpO1xuICAgIHJlcy5lbmQoKTtcbiAgfTtcbn1cbiJdfQ==