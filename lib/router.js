'use strict';

var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; })();

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Router = Router;

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _ciAdapter = require('ci-adapter');

var _util = require('util');

var _url = require('url');

var _id = require('./id');

var _model = require('./model');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function Router(adapter, options) {
  var router = _express2.default.Router();
  var model = (0, _model.Model)(adapter, {
    id: {
      get: function get() {
        return (0, _id.id)(this.data);
      }
    }
  });

  router.get('/', function (req, res, next) {
    var builders = model.builders();
    var builds = model.builds();

    Promise.all([builders.then(function (builders) {
      return Promise.all(builders.map(function (builder) {
        return builder.id;
      }));
    }), builds.then(function (builds) {
      return Promise.all(builds.map(function (build) {
        return build.id;
      }));
    }), builds.then(function (builds) {
      return builds.filter(function (build) {
        return build.state === _ciAdapter.state.PENDING;
      });
    })]).then(function (_ref) {
      var _ref2 = _slicedToArray(_ref, 3);

      var builders = _ref2[0];
      var builds = _ref2[1];
      var pending = _ref2[2];
      return { builders: builders, builds: builds, pending: pending };
    }).then(send(req, res), error(res));
  });

  router.get('/builders', function (req, res, next) {
    model.builders().then(function (builders) {
      return Promise.all(builders.map(builderData(req)));
    }).then(send(req, res), error(res));
  });

  router.get('/builds', function (req, res, next) {
    model.builds().then(function (builds) {
      return Promise.all(builds.map(buildData(req)));
    }).then(send(req, res), error(res));
  });

  router.get('/latest', function (req, res, next) {
    model.builds().then(function (builds) {
      return buildData(req)(builds[0]);
    }).then(send(req, res), error(res));
  });

  return router;
}

function getBaseUrl(req) {
  function first(string) {
    return string && string.split(/\s*,\s*/)[0];
  }

  var proto = first(req.headers['x-forwarded-proto']) || (req.socket.encrypted ? 'https' : 'http');
  var host = first(req.headers['x-forwarded-host']) || req.headers.host;
  var base = req.baseUrl || '';
  return proto + '://' + host + base;
}

function builderData(req) {
  var endpoint = getBaseUrl(req);
  return function (builder) {
    return builder.id.then(function (id) {
      var url = endpoint + '/builder/' + id;
      var urls = [builder.data.url].concat(builder.data.data.urls || []);
      var data = Object.assign({}, builder.data, { url: url, data: { urls: urls } });
      return data;
    });
  };
}

function buildData(req) {
  var endpoint = getBaseUrl(req);
  return function (build) {
    return build.id.then(function (id) {
      var url = endpoint + '/builder/' + id;
      var urls = [build.data.url].concat(build.data.data.urls || []);
      var data = Object.assign({}, build.data, { url: url, data: { urls: urls } });
      return data;
    });
  };
}

function send(req, res) {
  var url = req.parsedUrl || (0, _url.parse)(req.url, true);
  var pretty = !!url.query.pretty;
  return function (data) {
    res.setHeader('Content-Type', 'application/json');
    res.write(JSON.stringify(data, null, pretty && 2));
    res.end();
  };
  return function (data) {
    return res.json(data);
  };
}

function error(res) {
  return function (err) {
    res.statusCode = 500;
    res.setHeader('Content-Type', 'application/json');
    res.write(JSON.stringify({ message: err.toString() }));
    res.end();
  };
}
//# sourceMappingURL=data:application/json;base64,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LENBQUM7S0FDYixDQUFDLENBQUM7R0FDSixDQUFDO0NBQ0g7O0FBRUQsU0FBUyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtBQUN0QixNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsU0FBUyxJQUFJLFNBbkZ0QixLQUFLLEVBbUYwQixHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3JELE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBRSxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQUFBQyxDQUFDO0FBQ3BDLFNBQU8sVUFBVSxJQUFJLEVBQUU7QUFDckIsT0FBRyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztBQUNsRCxPQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuRCxPQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7R0FDWCxDQUFBO0FBQ0QsU0FBTyxVQUFBLElBQUk7V0FBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztHQUFBLENBQUM7Q0FDL0I7O0FBRUQsU0FBUyxLQUFLLENBQUMsR0FBRyxFQUFFO0FBQ2xCLFNBQU8sVUFBVSxHQUFHLEVBQUU7QUFDcEIsT0FBRyxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7QUFDckIsT0FBRyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztBQUNsRCxPQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELE9BQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztHQUNYLENBQUM7Q0FDSCIsImZpbGUiOiJyb3V0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHN0YXRlIH0gZnJvbSAnY2ktYWRhcHRlcic7XG5pbXBvcnQgeyBpbmhlcml0cyB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IHsgcGFyc2UgYXMgcGFyc2VVcmwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgaWQgfSBmcm9tICcuL2lkJztcbmltcG9ydCB7IE1vZGVsLCBCdWlsZCwgQnVpbGRlciB9IGZyb20gJy4vbW9kZWwnO1xuXG5leHBvcnQgZnVuY3Rpb24gUm91dGVyKGFkYXB0ZXIsIG9wdGlvbnMpIHtcbiAgY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbiAgY29uc3QgbW9kZWwgPSBNb2RlbChhZGFwdGVyLCB7XG4gICAgaWQ6IHtcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gaWQodGhpcy5kYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIHJvdXRlci5nZXQoJy8nLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICBjb25zdCBidWlsZGVycyA9IG1vZGVsLmJ1aWxkZXJzKCk7XG4gICAgY29uc3QgYnVpbGRzID0gbW9kZWwuYnVpbGRzKCk7XG5cbiAgICBQcm9taXNlLmFsbChbXG4gICAgICBidWlsZGVycy50aGVuKGJ1aWxkZXJzID0+IFByb21pc2UuYWxsKGJ1aWxkZXJzLm1hcChidWlsZGVyID0+IGJ1aWxkZXIuaWQpKSksXG4gICAgICBidWlsZHMudGhlbihidWlsZHMgPT4gUHJvbWlzZS5hbGwoYnVpbGRzLm1hcChidWlsZCA9PiBidWlsZC5pZCkpKSxcbiAgICAgIGJ1aWxkcy50aGVuKGJ1aWxkcyA9PiBidWlsZHMuZmlsdGVyKGJ1aWxkID0+IGJ1aWxkLnN0YXRlID09PSBzdGF0ZS5QRU5ESU5HKSlcbiAgICBdKS50aGVuKChbIGJ1aWxkZXJzLCBidWlsZHMsIHBlbmRpbmcgXSkgPT4gKHsgYnVpbGRlcnMsIGJ1aWxkcywgcGVuZGluZyB9KSkudGhlbihzZW5kKHJlcSwgcmVzKSwgZXJyb3IocmVzKSk7XG4gIH0pO1xuXG4gIHJvdXRlci5nZXQoJy9idWlsZGVycycsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIG1vZGVsLmJ1aWxkZXJzKClcbiAgICAgIC50aGVuKGJ1aWxkZXJzID0+IFByb21pc2UuYWxsKGJ1aWxkZXJzLm1hcChidWlsZGVyRGF0YShyZXEpKSkpXG4gICAgICAudGhlbihzZW5kKHJlcSwgcmVzKSwgZXJyb3IocmVzKSk7XG4gIH0pO1xuXG4gIHJvdXRlci5nZXQoJy9idWlsZHMnLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICBtb2RlbC5idWlsZHMoKVxuICAgICAgLnRoZW4oYnVpbGRzID0+IFByb21pc2UuYWxsKGJ1aWxkcy5tYXAoYnVpbGREYXRhKHJlcSkpKSlcbiAgICAgIC50aGVuKHNlbmQocmVxLCByZXMpLCBlcnJvcihyZXMpKTtcbiAgfSk7XG5cbiAgcm91dGVyLmdldCgnL2xhdGVzdCcsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIG1vZGVsLmJ1aWxkcygpXG4gICAgICAudGhlbihidWlsZHMgPT4gYnVpbGREYXRhKHJlcSkoYnVpbGRzWyAwIF0pKVxuICAgICAgLnRoZW4oc2VuZChyZXEsIHJlcyksIGVycm9yKHJlcykpO1xuICB9KTtcblxuICByZXR1cm4gcm91dGVyO1xufVxuXG5cbmZ1bmN0aW9uIGdldEJhc2VVcmwocmVxKSB7XG4gIGZ1bmN0aW9uIGZpcnN0KHN0cmluZykge1xuICAgIHJldHVybiBzdHJpbmcgJiYgc3RyaW5nLnNwbGl0KC9cXHMqLFxccyovKVswXTtcbiAgfVxuXG4gIGNvbnN0IHByb3RvID0gZmlyc3QocmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLXByb3RvJ10pIHx8ICggcmVxLnNvY2tldC5lbmNyeXB0ZWQgPyAnaHR0cHMnIDogJ2h0dHAnICk7XG4gIGNvbnN0IGhvc3QgPSBmaXJzdChyZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtaG9zdCddKSB8fCByZXEuaGVhZGVycy5ob3N0O1xuICBjb25zdCBiYXNlID0gcmVxLmJhc2VVcmwgfHwgJyc7XG4gIHJldHVybiBgJHtwcm90b306Ly8ke2hvc3R9JHtiYXNlfWBcbn1cblxuZnVuY3Rpb24gYnVpbGRlckRhdGEocmVxKSB7XG4gIGNvbnN0IGVuZHBvaW50ID0gZ2V0QmFzZVVybChyZXEpO1xuICByZXR1cm4gZnVuY3Rpb24gKGJ1aWxkZXIpIHtcbiAgICByZXR1cm4gYnVpbGRlci5pZC50aGVuKGZ1bmN0aW9uIChpZCkge1xuICAgICAgY29uc3QgdXJsID0gYCR7ZW5kcG9pbnR9L2J1aWxkZXIvJHtpZH1gO1xuICAgICAgY29uc3QgdXJscyA9IFsgYnVpbGRlci5kYXRhLnVybCBdLmNvbmNhdChidWlsZGVyLmRhdGEuZGF0YS51cmxzIHx8IFtdKTtcbiAgICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBidWlsZGVyLmRhdGEsIHsgdXJsLCBkYXRhOiB7IHVybHMgfX0pO1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YShyZXEpIHtcbiAgY29uc3QgZW5kcG9pbnQgPSBnZXRCYXNlVXJsKHJlcSk7XG4gIHJldHVybiBmdW5jdGlvbiAoYnVpbGQpIHtcbiAgICByZXR1cm4gYnVpbGQuaWQudGhlbihmdW5jdGlvbiAoaWQpIHtcbiAgICAgIGNvbnN0IHVybCA9IGAke2VuZHBvaW50fS9idWlsZGVyLyR7aWR9YDtcbiAgICAgIGNvbnN0IHVybHMgPSBbIGJ1aWxkLmRhdGEudXJsIF0uY29uY2F0KGJ1aWxkLmRhdGEuZGF0YS51cmxzIHx8IFtdKTtcbiAgICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBidWlsZC5kYXRhLCB7IHVybCwgZGF0YTogeyB1cmxzIH19KTtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0pO1xuICB9O1xufVxuXG5mdW5jdGlvbiBzZW5kKHJlcSwgcmVzKSB7XG4gIGNvbnN0IHVybCA9IHJlcS5wYXJzZWRVcmwgfHwgcGFyc2VVcmwocmVxLnVybCwgdHJ1ZSk7XG4gIGNvbnN0IHByZXR0eSA9ICEhKHVybC5xdWVyeS5wcmV0dHkpO1xuICByZXR1cm4gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIHJlcy53cml0ZShKU09OLnN0cmluZ2lmeShkYXRhLCBudWxsLCBwcmV0dHkgJiYgMikpO1xuICAgIHJlcy5lbmQoKTtcbiAgfVxuICByZXR1cm4gZGF0YSA9PiByZXMuanNvbihkYXRhKTtcbn1cblxuZnVuY3Rpb24gZXJyb3IocmVzKSB7XG4gIHJldHVybiBmdW5jdGlvbiAoZXJyKSB7XG4gICAgcmVzLnN0YXR1c0NvZGUgPSA1MDA7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICByZXMud3JpdGUoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBlcnIudG9TdHJpbmcoKSB9KSk7XG4gICAgcmVzLmVuZCgpO1xuICB9O1xufVxuIl19